---
import rat from "@assets/rat.png";
import cheese from "@assets/cheese.png";
import square from "@assets/square.png";

interface Props {
  classNames: string;
}
---

<div
  class="scramble-text py-4 text-center text-lg tracking-[0.2rem] text-slate-500 max-lg:hidden"
  data-original=""
  data-rat={rat.src}
  data-cheese={cheese.src}
  data-square={square.src}
>
  {
    Array.from({ length: 20 }).map(() => (
      <img class="inline w-10 px-2 align-bottom" src={square.src} alt="" />
    ))
  }
</div>

<style>
  .scramble-text {
    cursor: pointer;
    transition: color 0.3s ease;
  }
</style>

<script>
  class TextScrambler {
    private element: HTMLElement;
    private originalText: string;
    private isScrambling: boolean = false;
    private isUnscrambling: boolean = false;
    private scrambleInterval: number | null = null;
    private images: string[];
    private squareCount: number = 20;

    constructor(element: HTMLElement) {
      this.element = element;
      this.originalText = element.getAttribute("data-original") || element.textContent || "";

      // Read image paths from data attributes
      const ratImg = element.getAttribute("data-rat") || "";
      const cheeseImg = element.getAttribute("data-cheese") || "";
      const squareImg = element.getAttribute("data-square") || "";
      this.images = [ratImg, cheeseImg];

      this.init();
    }

    init(): void {
      this.element.addEventListener("mouseenter", () => this.scramble());
      this.element.addEventListener("mouseleave", () => this.unscramble());
    }

    private createImageTag(src: string): string {
      return `<img class="w-10 inline align-bottom px-2" src="${src}" alt="" />`;
    }

    scramble(): void {
      if (this.scrambleInterval !== null) {
        clearInterval(this.scrambleInterval);
        this.scrambleInterval = null;
      }

      this.isUnscrambling = false;
      this.isScrambling = true;

      let frame = 0;
      const maxFrames = 60;

      this.scrambleInterval = window.setInterval(() => {
        if (!this.isScrambling) {
          if (this.scrambleInterval !== null) {
            clearInterval(this.scrambleInterval);
            this.scrambleInterval = null;
          }
          return;
        }

        const scrambled = Array.from({ length: this.squareCount })
          .map(() => {
            const randomImage = this.images[Math.floor(Math.random() * this.images.length)];
            return this.createImageTag(randomImage);
          })
          .join("");

        this.element.innerHTML = scrambled;
        frame++;

        if (frame >= maxFrames) {
          if (this.scrambleInterval !== null) {
            clearInterval(this.scrambleInterval);
            this.scrambleInterval = null;
          }
        }
      }, 1000 / 60);
    }

    unscramble(): void {
      if (this.scrambleInterval !== null) {
        clearInterval(this.scrambleInterval);
        this.scrambleInterval = null;
      }

      this.isScrambling = false;
      this.isUnscrambling = true;

      let frame = 0;
      const maxFrames = 60;
      const squareImg = this.element.getAttribute("data-square") || "";

      this.scrambleInterval = window.setInterval(() => {
        if (!this.isUnscrambling) {
          if (this.scrambleInterval !== null) {
            clearInterval(this.scrambleInterval);
            this.scrambleInterval = null;
          }
          return;
        }

        const scrambled = Array.from({ length: this.squareCount })
          .map((_, index) => {
            const progress = frame / maxFrames;
            const revealThreshold = index / this.squareCount;

            if (progress > revealThreshold) {
              return this.createImageTag(squareImg);
            }

            const randomImage = this.images[Math.floor(Math.random() * this.images.length)];
            return this.createImageTag(randomImage);
          })
          .join("");

        this.element.innerHTML = scrambled;
        frame++;

        if (frame >= maxFrames) {
          this.element.innerHTML = Array.from({ length: this.squareCount })
            .map(() => this.createImageTag(squareImg))
            .join("");
          if (this.scrambleInterval !== null) {
            clearInterval(this.scrambleInterval);
            this.scrambleInterval = null;
          }
        }
      }, 1000 / 60);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const elements = document.querySelectorAll<HTMLElement>(".scramble-text");
    elements.forEach((element) => new TextScrambler(element));
  });
</script>
